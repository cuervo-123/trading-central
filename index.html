<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>THE APPTV CENTRAL ‚Äî Multi Monitor</title>

  <!-- Config CSE -->
  <script>
    window.__gcse = {
      parsetags: 'explicit',
      callback: function() {
        try {
          window.__CSE_READY__ = true;
          ['m1','m2','m3','m4'].forEach(renderCSEPair);
          console.log('CSE listo ‚úÖ');
        } catch (e) {
          console.warn('CSE callback error:', e);
        }
      }
    };
  </script>
  <script async src="https://cse.google.com/cse.js?cx=04f5ff6986fe641ad"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <!-- ======== TECH BLUE STYLE ======== -->
  <style>
    :root {
      --bg: #050a12;
      --bg-soft: #0b1224;
      --card: #0f1b33;
      --accent: #1f8bff;
      --accent-glow: #4ac3ff;
      --text: #eaf4ff;
      --text-dim: #93a4c4;
      --border: #1b2b4a;
      --radius: 12px;
      --shadow: 0 0 15px rgba(31,139,255,0.25);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top left, #081021 0%, #040814 100%);
      color: var(--text);
    }
    header, main, footer { padding: 1rem; }

    header {
      background: linear-gradient(180deg, #0d1528 0%, #0a0f20 100%);
      box-shadow: var(--shadow);
      border-bottom: 1px solid var(--border);
      border-radius: 0 0 var(--radius) var(--radius);
    }
    h1 {
      color: var(--accent-glow);
      text-shadow: 0 0 12px rgba(74,195,255,0.5);
      margin: 0 0 .75rem;
      letter-spacing: 0.5px;
      font-weight: 700;
    }

    /* Carrusel */
    #carrusel-wrapper { position: relative; }
    #canales-inferiores {
      display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 0.7rem;
      padding: 1rem; background: var(--card); border-radius: var(--radius);
      box-shadow: inset 0 0 10px rgba(31,139,255,0.12); scroll-behavior: smooth;
    }
    .canal {
      background: var(--accent); color: #fff; border-radius: var(--radius);
      padding: 0.5rem 1rem; cursor: pointer; white-space: nowrap; flex-shrink: 0;
      transition: all 0.25s ease;
    }
    .canal:hover { background: var(--accent-glow); box-shadow: 0 0 10px rgba(74,195,255,0.6); transform: translateY(-1px); }
    .flecha-carrusel {
      position: absolute; top: 50%; transform: translateY(-50%); font-size: 1.4rem; color: var(--accent-glow);
      background: rgba(0,0,0,0.5); border: 2px solid var(--accent); border-radius: 50%;
      width: 42px; height: 42px; cursor: pointer; z-index: 10; transition: all 0.3s ease; display: grid; place-items: center;
    }
    .flecha-carrusel:hover { background: var(--accent); color:#fff; box-shadow: 0 0 10px rgba(74,195,255,.5); }
    .flecha-izquierda { left: 5px; } .flecha-derecha { right: 5px; }

    /* Inputs y botones top */
    #youtube-controls { gap: .5rem; margin-top: 1rem; display:flex; flex-wrap:wrap; }
    #youtube-controls input, #buscador, #cargarArchivo {
      background: #0d182f; color: var(--text); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 0.5rem; transition: border-color 0.2s;
    }
    #youtube-controls input:focus, #buscador:focus { border-color: var(--accent-glow); outline: none; }

    button {
      padding: 0.45rem 0.8rem; background: var(--accent); border: none;
      border-radius: var(--radius); color: white; cursor: pointer; font-weight: 600;
      letter-spacing: .3px; transition: all 0.25s ease;
    }
    button:hover { background: var(--accent-glow); box-shadow: 0 0 10px rgba(74,195,255,0.6); transform: translateY(-1px); }

    /* Grid de monitores */
    .player-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1rem; margin-bottom: 1rem;
    }
    .player-container {
      position: relative; width: 100%; height: 55vh; background: var(--card); overflow: hidden;
      display:flex; flex-direction:column; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border);
    }
    video, .player-container iframe { width: 100%; height: 100%; object-fit: cover; border: none; }

    /* Encabezado del panel por monitor */
    .panel-header {
      display:flex; justify-content:space-between; align-items:center;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-glow) 100%);
      color:#fff; padding:6px 10px; font-weight:600;
    }
    .panel-header .left { display:flex; align-items:center; gap:8px; }
    .panel-header .right { display:flex; gap:6px; }
    .panel-header button { background:#fff; color:#0a0f20; border:none; padding:4px 10px; border-radius:6px; cursor:pointer; transition: all .2s; }
    .panel-header button:hover { background: var(--accent-glow); color:#fff; }

    /* Controles */
    .botones-panel { margin-top: 0.5rem; display: grid; grid-template-columns: 1fr; gap: .6rem; align-items: flex-start; }
    .site-controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .site-controls label { color: var(--text-dim); }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0; }
    .tab { padding:6px 10px; border:1px solid var(--border); border-radius:6px; cursor:pointer; background:#101d3b; color:#fff; transition:all .2s; }
    .tab.active, .tab:hover { background: var(--accent); color:#fff; box-shadow: 0 0 8px rgba(74,195,255,0.4); }
    .grid-split { display:grid; gap:8px; width:100%; height:100%; }

    /* Fullscreen */
    .fullscreen-iframe { position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 9999 !important; background: black !important; }
    .fullscreen-iframe-button { position: fixed; top: 10px; right: 10px; z-index: 10000; background: var(--accent); color: #fff; border: none; border-radius: var(--radius); padding: 6px 10px; cursor: pointer; box-shadow: 0 0 10px rgba(74,195,255,.45); }

    /* Modales */
    .modal { position: fixed; inset: 0; background: rgba(0,0,20,0.85); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: var(--card); color:#eaf4ff; padding: 1rem; border-radius: 10px; width: min(800px, 90vw); max-height: 80vh; overflow: auto; border: 1px solid var(--border); box-shadow: 0 0 20px rgba(31,139,255,0.3); }
    #listaFavoritos { list-style: none; padding: 0; margin:0; }
    #listaFavoritos li { padding: 0.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }

    /* Scrollbar */
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-track { background: #0c1328; }
    ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-glow); }

    /* --- Link Box (Tech Blue) --- */
    .link-toolbar {
      display: flex; flex-wrap: wrap; gap: .6rem; align-items: center;
      background: #0b152b; border: 1px solid var(--border); border-radius: var(--radius);
      padding: .55rem .6rem;
    }
    .link-toolbar input[type="text"]{
      flex: 1 1 260px; min-width: 200px;
      background: #0d182f; color: var(--text);
      border: 1px solid var(--border); border-radius: 10px; padding: .45rem .6rem;
    }
    .link-toolbar input[type="text"]::placeholder{ color: #6f82a9; }
    .link-toolbar .spacer{ flex: 999 1 0; } /* empuja acciones a la derecha */
    .compact-toggle { display:flex; align-items:center; gap:.45rem; color: var(--text-dim); }
    .compact-toggle input { width: 18px; height: 18px; }

    .link-actions { display: flex; gap: .5rem; align-items: center; flex-wrap: wrap; color: var(--text-dim); }
    .link-actions button { padding: .35rem .6rem; font-weight: 600; }

    .link-box {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: .6rem; width: 100%;
    }
    .link-box.compact { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: .5rem; }

    .link-card {
      display: grid; grid-template-columns: 36px 1fr auto;
      align-items: center; gap: .6rem; padding: .6rem .7rem;
      background: #0d182f; border: 1px solid var(--border); border-radius: var(--radius);
      box-shadow: 0 0 8px rgba(31,139,255,.12);
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s, background .2s;
      cursor: grab;
    }
    .link-box.compact .link-card { grid-template-columns: 28px 1fr auto; padding: .45rem .55rem; }
    .link-card:hover { transform: translateY(-1px); box-shadow: 0 0 12px rgba(74,195,255,.28); border-color: var(--accent); }
    .link-card.selected { background: linear-gradient(180deg, #0f1f3d 0%, #0d182f 100%); border-color: var(--accent); box-shadow: 0 0 14px rgba(74,195,255,.35); }
    .link-card.dragging { opacity: .6; cursor: grabbing; }
    .link-card.drop-before::before,
    .link-card.drop-after::after { content: ""; position: absolute; left: 0; right: 0; height: 0; border-top: 2px dashed var(--accent-glow); }
    .link-card.drop-before { position: relative; }
    .link-card.drop-before::before { top: -4px; }
    .link-card.drop-after { position: relative; }
    .link-card.drop-after::after { bottom: -4px; }

    .link-fav { width: 28px; height: 28px; border-radius: 6px; background: #0b152b; display: grid; place-items: center; overflow: hidden; }
    .link-fav img { width: 20px; height: 20px; }
    .link-box.compact .link-fav { width: 24px; height: 24px; }
    .link-box.compact .link-fav img { width: 18px; height: 18px; }

    .link-info { display: flex; flex-direction: column; min-width: 0; }
    .link-title { color: var(--text); font-weight: 600; font-size: .95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .link-host { color: var(--text-dim); font-size: .78rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .link-box.compact .link-title { font-size: .88rem; }
    .link-box.compact .link-host { font-size: .72rem; }

    .link-ctrl { display: flex; align-items: center; gap: .4rem; }
    .link-ctrl input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    /* Oculta el <select multiple> tradicional */
    .site-select { display: none !important; }
  </style>
</head>
<body>
  <header>
    <h1>THE APPTV CENTRAL</h1>

    <div id="carrusel-wrapper">
      <button class="flecha-carrusel flecha-izquierda" onclick="scrollCarrusel(-1)">‚¨ÖÔ∏è</button>
      <div id="canales-inferiores"></div>
      <button class="flecha-carrusel flecha-derecha" onclick="scrollCarrusel(1)">‚û°Ô∏è</button>
    </div>

    <div id="youtube-controls" style="display: flex;">
      <input id="youtubeSearch" type="text" placeholder="Buscar en YouTube..." style="flex: 1;" />
      <button onclick="buscarYT()">üîç Buscar</button>
      <button onclick="toggleRotacion()">‚è∏Ô∏è Pausar</button>
      <button onclick="siguienteVideo()">‚è≠Ô∏è Siguiente</button>
    </div>

    <input type="text" id="buscador" placeholder="Buscar canal de la lista..." />
    <input type="file" id="cargarArchivo" accept=".m3u" />
    <button onclick="cargarCanalesInternos()">üéûÔ∏è Cargar Canales Internos</button>
    <button onclick="mostrarFavoritos()">üìÅ Ver Favoritos</button>
    <button onclick="exportarFavoritos()">üíæ Exportar Favoritos</button>
    <button onclick="desbloquearAdulto()">üîêüîë Desbloquear Adultos</button>

    <div style="margin-top:8px;">
      <button onclick="limpiarResultados()">üßπ Limpiar TODO (m1‚Äìm4)</button>
    </div>
  </header>

  <main>
    <div class="player-grid">
      <!-- MONITOR 1 -->
      <div class="player-container" data-index="0" id="monitor0">
        <div class="panel-header">
          <div class="left"><strong>Monitor 1</strong></div>
          <div class="right">
            <button onclick="limpiarBusqueda('m1')">üßπ Limpiar</button>
            <button id="btnFullscreen0" onclick="toggleFullscreenGrafico(0)">üîç Fullscreen</button>
          </div>
        </div>
        <div id="searchbox-m1"></div>
        <div id="results-m1" class="gcse-results-host"></div>

        <div class="botones-panel">
          <select id="siteSelect0" multiple size="5" class="site-select"></select>

          <!-- NUEVA TOOLBAR -->
          <div class="link-toolbar">
            <input type="text" id="lbFilter0" placeholder="Filtrar sitios (nombre, host o URL)..." oninput="lbApplyFilter(0)">
            <div class="spacer"></div>
            <label class="compact-toggle">
              <input type="checkbox" id="lbCompact0" onchange="lbToggleCompact(0)"> Compact
            </label>
            <div class="link-actions">
              <button type="button" onclick="lbSelectAll(0)">Seleccionar todos</button>
              <button type="button" onclick="lbInvert(0)">Invertir</button>
              <button type="button" onclick="lbClear(0)">Limpiar</button>
            </div>
          </div>

          <div id="linkBox0" class="link-box"></div>

          <div class="site-controls">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="splitMode0" checked> Vista dividida
            </label>
            <button onclick="cargarGraficoTV(0)">üåê Abrir sitios</button>
            <button onclick="guardarSeleccionSitios(0)">üíæ Guardar</button>
            <button onclick="limpiarSeleccionSitios(0)">üßπ Limpiar</button>
          </div>
        </div>
        <div class="botones-panel">
          <input type="text" id="symbolInput0" placeholder="S√≠mbolo (ej: EURUSD)" style="padding:0.5rem;" />
          <button onclick="cargarGraficoTV(0)">üìà Gr√°fico</button>
          <button onclick="quitarGraficoTV(0)">üóëÔ∏è Quitar</button>
        </div>
      </div>

      <!-- MONITOR 2 -->
      <div class="player-container" data-index="1" id="monitor1">
        <div class="panel-header">
          <div class="left"><strong>Monitor 2</strong></div>
          <div class="right">
            <button onclick="limpiarBusqueda('m2')">üßπ Limpiar</button>
            <button id="btnFullscreen1" onclick="toggleFullscreenGrafico(1)">üîç Fullscreen</button>
          </div>
        </div>
        <div id="searchbox-m2"></div>
        <div id="results-m2" class="gcse-results-host"></div>

        <div class="botones-panel">
          <select id="siteSelect1" multiple size="5" class="site-select"></select>

          <div class="link-toolbar">
            <input type="text" id="lbFilter1" placeholder="Filtrar sitios (nombre, host o URL)..." oninput="lbApplyFilter(1)">
            <div class="spacer"></div>
            <label class="compact-toggle">
              <input type="checkbox" id="lbCompact1" onchange="lbToggleCompact(1)"> Compact
            </label>
            <div class="link-actions">
              <button type="button" onclick="lbSelectAll(1)">Seleccionar todos</button>
              <button type="button" onclick="lbInvert(1)">Invertir</button>
              <button type="button" onclick="lbClear(1)">Limpiar</button>
            </div>
          </div>

          <div id="linkBox1" class="link-box"></div>

          <div class="site-controls">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="splitMode1" checked> Vista dividida
            </label>
            <button onclick="cargarGraficoTV(1)">üåê Abrir sitios</button>
            <button onclick="guardarSeleccionSitios(1)">üíæ Guardar</button>
            <button onclick="limpiarSeleccionSitios(1)">üßπ Limpiar</button>
          </div>
        </div>
        <div class="botones-panel">
          <input type="text" id="symbolInput1" placeholder="S√≠mbolo (ej: EURUSD)" style="padding:0.5rem;" />
          <button onclick="cargarGraficoTV(1)">üìà Gr√°fico</button>
          <button onclick="quitarGraficoTV(1)">üóëÔ∏è Quitar</button>
        </div>
      </div>

      <!-- MONITOR 3 -->
      <div class="player-container" data-index="2" id="monitor2">
        <div class="panel-header">
          <div class="left"><strong>Monitor 3</strong></div>
          <div class="right">
            <button onclick="limpiarBusqueda('m3')">üßπ Limpiar</button>
            <button id="btnFullscreen2" onclick="toggleFullscreenGrafico(2)">üîç Fullscreen</button>
          </div>
        </div>
        <div id="searchbox-m3"></div>
        <div id="results-m3" class="gcse-results-host"></div>

        <div class="botones-panel">
          <select id="siteSelect2" multiple size="5" class="site-select"></select>

          <div class="link-toolbar">
            <input type="text" id="lbFilter2" placeholder="Filtrar sitios (nombre, host o URL)..." oninput="lbApplyFilter(2)">
            <div class="spacer"></div>
            <label class="compact-toggle">
              <input type="checkbox" id="lbCompact2" onchange="lbToggleCompact(2)"> Compact
            </label>
            <div class="link-actions">
              <button type="button" onclick="lbSelectAll(2)">Seleccionar todos</button>
              <button type="button" onclick="lbInvert(2)">Invertir</button>
              <button type="button" onclick="lbClear(2)">Limpiar</button>
            </div>
          </div>

          <div id="linkBox2" class="link-box"></div>

          <div class="site-controls">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="splitMode2" checked> Vista dividida
            </label>
            <button onclick="cargarGraficoTV(2)">üåê Abrir sitios</button>
            <button onclick="guardarSeleccionSitios(2)">üíæ Guardar</button>
            <button onclick="limpiarSeleccionSitios(2)">üßπ Limpiar</button>
          </div>
        </div>
        <div class="botones-panel">
          <input type="text" id="symbolInput2" placeholder="S√≠mbolo (ej: EURUSD)" style="padding:0.5rem;" />
          <button onclick="cargarGraficoTV(2)">üìà Gr√°fico</button>
          <button onclick="quitarGraficoTV(2)">üóëÔ∏è Quitar</button>
        </div>
      </div>

      <!-- MONITOR 4 -->
      <div class="player-container" data-index="3" id="monitor3">
        <div class="panel-header">
          <div class="left"><strong>Monitor 4</strong></div>
          <div class="right">
            <button onclick="limpiarBusqueda('m4')">üßπ Limpiar</button>
            <button id="btnFullscreen3" onclick="toggleFullscreenGrafico(3)">üîç Fullscreen</button>
          </div>
        </div>
        <div id="searchbox-m4"></div>
        <div id="results-m4" class="gcse-results-host"></div>

        <div class="botones-panel">
          <select id="siteSelect3" multiple size="5" class="site-select"></select>

          <div class="link-toolbar">
            <input type="text" id="lbFilter3" placeholder="Filtrar sitios (nombre, host o URL)..." oninput="lbApplyFilter(3)">
            <div class="spacer"></div>
            <label class="compact-toggle">
              <input type="checkbox" id="lbCompact3" onchange="lbToggleCompact(3)"> Compact
            </label>
            <div class="link-actions">
              <button type="button" onclick="lbSelectAll(3)">Seleccionar todos</button>
              <button type="button" onclick="lbInvert(3)">Invertir</button>
              <button type="button" onclick="lbClear(3)">Limpiar</button>
            </div>
          </div>

          <div id="linkBox3" class="link-box"></div>

          <div class="site-controls">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="splitMode3" checked> Vista dividida
            </label>
            <button onclick="cargarGraficoTV(3)">üåê Abrir sitios</button>
            <button onclick="guardarSeleccionSitios(3)">üíæ Guardar</button>
            <button onclick="limpiarSeleccionSitios(3)">üßπ Limpiar</button>
          </div>
        </div>
        <div class="botones-panel">
          <input type="text" id="symbolInput3" placeholder="S√≠mbolo (ej: EURUSD)" style="padding:0.5rem;" />
          <button onclick="cargarGraficoTV(3)">üìà Gr√°fico</button>
          <button onclick="quitarGraficoTV(3)">üóëÔ∏è Quitar</button>
        </div>
      </div>

    </div>
  </main>

  <!-- MODALES -->
  <div class="modal" id="modalFavoritos">
    <div class="modal-content">
      <h3>üéØ Favoritos</h3>
      <ul id="listaFavoritos"></ul>
      <div style="text-align:right;margin-top:10px;">
        <button onclick="cerrarModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalPantalla">
    <div class="modal-content">
      <h3>üñ•Ô∏è ¬øEn qu√© pantalla quieres ver este canal?</h3>
      <div style="display:flex; gap: 1rem; justify-content:center; margin: 1rem 0;">
        <button onclick="reproducirEnPantallaSeleccionada(0)">Pantalla 1</button>
        <button onclick="reproducirEnPantallaSeleccionada(1)">Pantalla 2</button>
        <button onclick="reproducirEnPantallaSeleccionada(2)">Pantalla 3</button>
        <button onclick="reproducirEnPantallaSeleccionada(3)">Pantalla 4</button>
      </div>
      <div style="text-align:right;">
        <button onclick="cerrarModalPantalla()">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    /* ====== CSE program√°tico ====== */
    function renderCSEPair(gname) {
      google.search.cse.element.render({
        div: 'searchbox-' + gname,
        tag: 'searchbox-only',
        gname: gname,
        attributes: { enableAutoComplete: true, autoCompleteMaxCompletions: 8 }
      });
      google.search.cse.element.render({
        div: 'results-' + gname,
        tag: 'searchresults-only',
        gname: gname
      });
    }
    function resetAndRenderCSE(gname) {
      const sb = document.getElementById('searchbox-' + gname);
      const rs = document.getElementById('results-' + gname);
      if (sb) sb.innerHTML = '';
      if (rs) rs.innerHTML = '';
      if (window.__CSE_READY__) renderCSEPair(gname);
    }

    /* ========= CARRUSEL ========= */
    function scrollCarrusel(direccion) {
      const carrusel = document.getElementById("canales-inferiores");
      carrusel.scrollBy({ left: 300 * direccion, behavior: "smooth" });
    }

    /* ========= UTIL: parse M3U ========= */
    function parseM3U(texto) {
      const lineas = texto.split('\n');
      const canales = [];
      for (let i = 0; i < lineas.length; i++) {
        const linea = lineas[i].trim();
        if (linea.startsWith('#EXTINF')) {
          const titulo = linea.split(',')[1]?.trim() || 'Canal sin nombre';
          const url = lineas[i + 1]?.trim();
          if (url && url.startsWith('http')) canales.push({ nombre: titulo, url });
        }
      }
      return canales;
    }

    let canalSeleccionado = null;
    let listaOriginalCanales = [];

    function mostrarCanales(canales, guardarOriginal = false) {
      if (guardarOriginal) listaOriginalCanales = canales;
      const contenedor = document.getElementById("canales-inferiores");
      contenedor.innerHTML = "";
      canales.forEach((canal) => {
        const div = document.createElement("div");
        div.className = "canal";
        div.textContent = canal.nombre;
        div.onclick = () => mostrarModalPantalla(canal.url);
        contenedor.appendChild(div);
      });
    }

    function filtrarCanales() {
      const texto = (document.getElementById("buscador").value || "").toLowerCase();
      const filtrados = listaOriginalCanales.filter(canal =>
        (canal.nombre || "").toLowerCase().includes(texto)
      );
      mostrarCanales(filtrados);
    }
    document.addEventListener('DOMContentLoaded', () => {
      const buscador = document.getElementById("buscador");
      if (buscador) buscador.addEventListener("input", filtrarCanales);
    });

    /* ========= Modal elegir pantalla ========= */
    function mostrarModalPantalla(url) {
      canalSeleccionado = url;
      document.getElementById("modalPantalla").style.display = "flex";
    }
    function cerrarModalPantalla() {
      document.getElementById("modalPantalla").style.display = "none";
      canalSeleccionado = null;
    }
    function reproducirEnPantallaSeleccionada(pantallaIndex) {
      if (canalSeleccionado) {
        const container = document.querySelector(`.player-container[data-index='${pantallaIndex}']`);
        container.innerHTML = `<div class="panel-header">
            <div class="left"><strong>Monitor ${pantallaIndex+1}</strong></div>
            <div class="right">
              <button onclick="limpiarBusqueda('m${pantallaIndex+1}')">üßπ Limpiar</button>
              <button id="btnFullscreen${pantallaIndex}" onclick="toggleFullscreenGrafico(${pantallaIndex})">üîç Fullscreen</button>
            </div>
          </div>
          <video id="player${pantallaIndex + 1}" controls></video>
          <div id="searchbox-m${pantallaIndex+1}"></div>
          <div id="results-m${pantallaIndex+1}" class="gcse-results-host"></div>`;
        reproducirCanal(canalSeleccionado, pantallaIndex);
        resetAndRenderCSE('m' + (pantallaIndex+1));
      }
      cerrarModalPantalla();
    }

    /* ========= Reproducir HLS ========= */
    function reproducirCanal(url, playerIndex) {
      const player = document.getElementById(`player${playerIndex + 1}`);
      if (player && player.hlsInstance) player.hlsInstance.destroy();

      if (player && Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(player);
        player.hlsInstance = hls;
        hls.on(Hls.Events.MANIFEST_PARSED, () => player.play());
      } else if (player && player.canPlayType && player.canPlayType('application/vnd.apple.mpegurl')) {
        player.src = url;
        player.addEventListener('loadedmetadata', () => player.play());
      } else {
        alert("Tu navegador no soporta la reproducci√≥n de este canal.");
      }
    }

    /* ========= Carga autom√°tica de listas ========= */
    Promise.all([
      fetch("update2.m3u").then(res => res.text()),
      fetch("xumo.m3u").then(res => res.text()),
      fetch("xiaomi.m3u").then(res => res.text())
    ])
    .then(([data1, data2, data3]) => {
      const canales = [...parseM3U(data1), ...parseM3U(data2), ...parseM3U(data3)];
      mostrarCanales(canales, true);
      console.log("‚úÖ Todas las listas M3U fueron cargadas autom√°ticamente");
    })
    .catch(err => console.error("‚ùå Error al cargar alguna lista M3U:", err));

    /* ========= YouTube con rotaci√≥n ========= */
    let apiKey = "AIzaSyA4NpwgJmEzBGGTzFFjShyrtWICgSSml-I";
    let rotationInterval = null, currentVideoIndex = 0, youtubeResults = [], isPaused = false;

    function targetIndexForYouTube() {
      const hasCSE = !!document.querySelector(".player-container[data-index='0'] #results-m1");
      return hasCSE ? 1 : 0;
    }

    function buscarYT() {
      const query = document.getElementById("youtubeSearch").value.trim();
      if (!query) return alert("Escribe una b√∫squeda.");
      fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=40&q=${encodeURIComponent(query)}&key=${apiKey}`)
        .then(res => res.json())
        .then(data => {
          if (!data.items || !data.items.length) return alert("No se encontraron resultados.");
          youtubeResults = data.items;
          currentVideoIndex = 0;
          reproducirVideoActual();
          iniciarRotacion();
        })
        .catch(err => { console.error("Error al buscar en YouTube:", err); alert("Error al buscar videos."); });
    }

    function reproducirVideoActual() {
      const video = youtubeResults[currentVideoIndex]; if (!video) return;
      const videoId = video.id.videoId;
      const iframe = document.createElement("iframe");
      iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0`;
      iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
      iframe.allowFullscreen = true;
      const idx = targetIndexForYouTube();
      const container = document.querySelector(`.player-container[data-index='${idx}']`);
      const header = container.querySelector(".panel-header")?.outerHTML || "";
      container.innerHTML = `${header}
        <div id="searchbox-m${idx+1}"></div>
        <div id="results-m${idx+1}" class="gcse-results-host"></div>`;
      container.appendChild(iframe);
      resetAndRenderCSE('m' + (idx+1));
    }

    function iniciarRotacion() {
      detenerRotacion();
      rotationInterval = setInterval(() => { if (!isPaused) siguienteVideo(); }, 3 * 60 * 1000);
    }
    function detenerRotacion() { if (rotationInterval) clearInterval(rotationInterval); }
    function toggleRotacion() { isPaused = !isPaused; alert(isPaused ? "‚è∏Ô∏è Rotaci√≥n pausada." : "‚ñ∂Ô∏è Rotaci√≥n reanudada."); }
    function siguienteVideo() { currentVideoIndex = (currentVideoIndex + 1) % youtubeResults.length; reproducirVideoActual(); }

    /* ========= Sitios favoritos ========= */
    const FAVORITE_SITES = [
      { label: "Central App's", url: "https://cuervo-123.github.io/GLOBALTV4YOUPLUS/" },
      { label: "Global country Tv App", url: "https://cuervo-123.github.io/tv4you/" },
      { label: "Logo full acces app", url: "https://cuervo-123.github.io/mi-tv-station/" },
      { label: "4 monitors pro app", url: "https://cuervo-123.github.io/GLOBALTV4YOU/" },
      { label: "Karaoke app pro", url: "https://cuervo-123.github.io/Editor-iptv-Plus/" },
      { label: "x app", url: "https://wap.tizam.club/fil_my_dlya_vzroslyh/podrostki_18/ryzhen_kie_ochen_seksual_ny_5/" },
      { label: "W3U Database", url: "https://cuervo-123.github.io/w3u-reader-iptv-plus/" },
      { label: "radio pro", url: "https://cuervo-123.github.io/radio-pro/" },
      { label: "Multi Film Pro Master ", url: "https://cuervo-123.github.io/Ximena-homepage/" },
      { label: "App Central Network ", url: "https://cuervo-123.github.io/mi-tv-station-network/" },      
      { label: "Multi Functions pro", url: "https://cuervo-123.github.io/mi-tv-station-v-10.1/" },
      { label: "weltrade", url: "https://www.weltrade.com/tools/charts/" }
    ];
    const LS_KEY = (idx) => `siteSelection:${idx}`;
    const ORDER_KEY = (idx) => `siteOrder:${idx}`;
    const COMPACT_KEY = (idx) => `siteCompact:${idx}`;
    const normalizeUrl = (u) => {
      if (!u) return "";
      let url = u.trim();
      if (!/^https?:\/\//i.test(url)) url = "https://" + url.replace(/^\/+/, "");
      return url;
    };

    /* ====== Link Box helpers ====== */
    function faviconURL(u){
      try { return 'https://www.google.com/s2/favicons?sz=64&domain=' + (new URL(u)).hostname; }
      catch { return 'https://www.google.com/s2/favicons?sz=64&domain=example.com'; }
    }
    function hostOf(u){
      try { return (new URL(u)).hostname; } catch { return u; }
    }

    function getSavedOrder(index){
      try { return JSON.parse(localStorage.getItem(ORDER_KEY(index)) || "[]"); } catch { return []; }
    }
    function saveOrder(index, arr){
      try { localStorage.setItem(ORDER_KEY(index), JSON.stringify(arr)); } catch {}
    }
    function getCompact(index){
      try { return JSON.parse(localStorage.getItem(COMPACT_KEY(index)) || "false"); } catch { return false; }
    }
    function setCompact(index, val){
      try { localStorage.setItem(COMPACT_KEY(index), JSON.stringify(!!val)); } catch {}
    }

    function renderLinkBox(index){
      const select = document.getElementById(`siteSelect${index}`);
      const box = document.getElementById(`linkBox${index}`);
      if(!select || !box) return;

      const selected = new Set(Array.from(select.selectedOptions).map(o=>o.value));
      // Opciones base
      let opts = Array.from(select.options).map(o => ({
        url: o.value,
        label: (o.text || o.value).split(' ‚Äî ')[0] || o.value,
        host: hostOf(o.value)
      }));
      // Reordenar seg√∫n orden guardado
      const savedOrder = getSavedOrder(index);
      if (savedOrder.length) {
        const orderMap = new Map(savedOrder.map((u,i)=>[u,i]));
        opts.sort((a,b) => (orderMap.has(a.url)?orderMap.get(a.url):1e9) - (orderMap.has(b.url)?orderMap.get(b.url):1e9));
      }

      box.innerHTML = opts.map(({url,label,host})=>{
        const isSel = selected.has(url);
        return `
          <div class="link-card ${isSel?'selected':''}" data-url="${url}" data-label="${label.toLowerCase()}" data-host="${host.toLowerCase()}" data-full="${url.toLowerCase()}" draggable="true">
            <div class="link-fav"><img src="${faviconURL(url)}" alt=""></div>
            <div class="link-info">
              <div class="link-title" title="${label}">${label}</div>
              <div class="link-host" title="${url}">${host}</div>
            </div>
            <div class="link-ctrl">
              <input type="checkbox" ${isSel?'checked':''}>
            </div>
          </div>
        `;
      }).join('');

      // Compact UI
      const compact = getCompact(index);
      const compactChk = document.getElementById(`lbCompact${index}`);
      if (compactChk) compactChk.checked = compact;
      box.classList.toggle('compact', compact);

      // Interacciones (selecci√≥n + drag)
      enableLinkCardInteractions(index);
      lbEnableDrag(index);

      // Aplicar filtro actual si hay
      lbApplyFilter(index);
    }

    function lbSyncSelectFromBox(index){
      const select = document.getElementById(`siteSelect${index}`);
      const box = document.getElementById(`linkBox${index}`);
      if(!select || !box) return;
      const chosen = new Set(
        Array.from(box.querySelectorAll('.link-card.selected')).map(c => c.getAttribute('data-url'))
      );
      Array.from(select.options).forEach(o => o.selected = chosen.has(o.value));
    }

    function enableLinkCardInteractions(index){
      const box = document.getElementById(`linkBox${index}`);
      if(!box) return;
      box.querySelectorAll('.link-card').forEach(card=>{
        card.addEventListener('click', (e)=>{
          if (e.target && e.target.matches('input[type="checkbox"]')) return;
          card.classList.toggle('selected');
          const chk = card.querySelector('input[type="checkbox"]');
          if (chk) chk.checked = card.classList.contains('selected');
          lbSyncSelectFromBox(index);
        });
        const chk = card.querySelector('input[type="checkbox"]');
        if (chk) chk.addEventListener('click', (e)=>{
          e.stopPropagation();
          card.classList.toggle('selected', chk.checked);
          lbSyncSelectFromBox(index);
        });
      });
    }

    /* ====== Drag & Drop ====== */
    function lbEnableDrag(index){
      const box = document.getElementById(`linkBox${index}`);
      if(!box) return;
      let dragEl = null;

      box.querySelectorAll('.link-card').forEach(card=>{
        card.addEventListener('dragstart', (e)=>{
          dragEl = card;
          card.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          try { e.dataTransfer.setData('text/plain', card.getAttribute('data-url')); } catch {}
        });
        card.addEventListener('dragend', ()=>{
          if(dragEl){ dragEl.classList.remove('dragging'); dragEl = null; }
          saveCurrentOrder(index);
        });

        card.addEventListener('dragover', (e)=>{
          e.preventDefault();
          if(!dragEl || dragEl === card) return;
          const rect = card.getBoundingClientRect();
          const before = (e.clientY - rect.top) < rect.height / 2;
          card.classList.toggle('drop-before', before);
          card.classList.toggle('drop-after', !before);
        });
        card.addEventListener('dragleave', ()=>{
          card.classList.remove('drop-before','drop-after');
        });
        card.addEventListener('drop', (e)=>{
          e.preventDefault();
          if(!dragEl || dragEl === card) return;
          const before = card.classList.contains('drop-before');
          card.classList.remove('drop-before','drop-after');
          if (before) {
            box.insertBefore(dragEl, card);
          } else {
            box.insertBefore(dragEl, card.nextSibling);
          }
          saveCurrentOrder(index);
        });
      });

      function saveCurrentOrder(idx){
        const order = Array.from(box.querySelectorAll('.link-card')).map(c=>c.getAttribute('data-url'));
        saveOrder(idx, order);
      }
    }

    /* ====== Toolbar: Filtro & Compact ====== */
    function lbApplyFilter(index){
      const box = document.getElementById(`linkBox${index}`);
      const input = document.getElementById(`lbFilter${index}`);
      if(!box || !input) return;
      const q = (input.value || '').trim().toLowerCase();
      const cards = box.querySelectorAll('.link-card');
      if(!q){
        cards.forEach(c => c.style.display = '');
        return;
      }
      cards.forEach(c=>{
        const label = c.getAttribute('data-label') || '';
        const host  = c.getAttribute('data-host')  || '';
        const full  = c.getAttribute('data-full')  || '';
        const show = label.includes(q) || host.includes(q) || full.includes(q);
        c.style.display = show ? '' : 'none';
      });
    }

    function lbToggleCompact(index){
      const box = document.getElementById(`linkBox${index}`);
      const chk = document.getElementById(`lbCompact${index}`);
      if(!box || !chk) return;
      const isOn = !!chk.checked;
      box.classList.toggle('compact', isOn);
      setCompact(index, isOn);
    }

    /* ====== Acciones selecci√≥n ====== */
    function lbSelectAll(index){
      const box = document.getElementById(`linkBox${index}`); if(!box) return;
      box.querySelectorAll('.link-card').forEach(c=>{
        c.classList.add('selected');
        const chk = c.querySelector('input[type="checkbox"]'); if(chk) chk.checked = true;
      });
      lbSyncSelectFromBox(index);
    }
    function lbInvert(index){
      const box = document.getElementById(`linkBox${index}`); if(!box) return;
      box.querySelectorAll('.link-card').forEach(c=>{
        const sel = c.classList.toggle('selected');
        const chk = c.querySelector('input[type="checkbox"]'); if(chk) chk.checked = sel;
      });
      lbSyncSelectFromBox(index);
    }
    function lbClear(index){
      const box = document.getElementById(`linkBox${index}`); if(!box) return;
      box.querySelectorAll('.link-card').forEach(c=>{
        c.classList.remove('selected');
        const chk = c.querySelector('input[type="checkbox"]'); if(chk) chk.checked = false;
      });
      lbSyncSelectFromBox(index);
    }

    /* ====== Picker y acciones (integrado con Link Box + Orden + Compact) ====== */
    function initSitePicker(index) {
      const select = document.getElementById(`siteSelect${index}`);
      if (!select) return;

      // Rellena el select oculto con FAVORITE_SITES
      select.innerHTML = FAVORITE_SITES.map(s =>
        `<option value="${s.url}">${s.label} ‚Äî ${s.url}</option>`
      ).join("");

      // Recupera guardado (selecci√≥n)
      const savedSel = JSON.parse(localStorage.getItem(LS_KEY(index)) || "[]");
      Array.from(select.options).forEach(opt => { opt.selected = savedSel.includes(opt.value); });

      // Compact inicial
      const compact = getCompact(index);
      const compactChk = document.getElementById(`lbCompact${index}`);
      if (compactChk) compactChk.checked = compact;

      // Render Link Box con orden + compact + filtro
      renderLinkBox(index);
    }

    function guardarSeleccionSitios(index) {
      lbSyncSelectFromBox(index);
      const select = document.getElementById(`siteSelect${index}`);
      const seleccion = Array.from(select.selectedOptions).map(o => o.value);
      localStorage.setItem(LS_KEY(index), JSON.stringify(seleccion));
      alert("Selecci√≥n guardada ‚úÖ");
    }

    function limpiarSeleccionSitios(index) {
      lbClear(index);
      const select = document.getElementById(`siteSelect${index}`);
      Array.from(select.options).forEach(o => (o.selected = false));
      localStorage.removeItem(LS_KEY(index));
    }

    function getUrlsFromLinkBoxInOrder(index){
      const box = document.getElementById(`linkBox${index}`);
      if(!box) return [];
      // Solo seleccionados, en el orden visual actual (aunque est√©n ocultos por filtro, si est√°n seleccionados, cuentan)
      const cards = Array.from(box.querySelectorAll('.link-card.selected'));
      return cards.map(c => normalizeUrl(c.getAttribute('data-url'))).filter(Boolean);
    }

    function renderIframesInContainer(index, urls) {
      const container = document.querySelector(`.player-container[data-index='${index}']`);
      if (!container) return;
      const cleanUrls = urls.map(normalizeUrl).filter(Boolean);
      if (cleanUrls.length === 0) return alert("Selecciona al menos 1 sitio.");
      const split = document.getElementById(`splitMode${index}`)?.checked && cleanUrls.length > 1;

      if (split) {
        const n = cleanUrls.length;
        let cols = 2; if (n === 3) cols = 3; if (n >= 4) cols = 3;
        const gridStyle = `grid-template-columns: repeat(${cols}, 1fr); grid-auto-rows: minmax(200px, 1fr);`;
        container.innerHTML = `
          <div class="panel-header">
            <div class="left"><strong>Monitor ${index+1}</strong></div>
            <div class="right">
              <button onclick="limpiarBusqueda('m${index+1}')">üßπ Limpiar</button>
              <button id="btnFullscreen${index}" onclick="toggleFullscreenGrafico(${index})">üîç Fullscreen</button>
            </div>
          </div>
          <div class="grid-split" style="${gridStyle}; width:100%; height:calc(100% - 40px);">
            ${cleanUrls.map(u => `
              <iframe src="${u}" style="width:100%; height:100%; border:0;"
                      frameborder="0" scrolling="auto"
                      allow="fullscreen; clipboard-read; clipboard-write"></iframe>
            `).join("")}
          </div>
          <div id="searchbox-m${index+1}"></div>
          <div id="results-m${index+1}" class="gcse-results-host"></div>
        `;
      } else if (cleanUrls.length === 1) {
        container.innerHTML = `
          <div class="panel-header">
            <div class="left"><strong>Monitor ${index+1}</strong></div>
            <div class="right">
              <button onclick="limpiarBusqueda('m${index+1}')">üßπ Limpiar</button>
              <button id="btnFullscreen${index}" onclick="toggleFullscreenGrafico(${index})">üîç Fullscreen</button>
            </div>
          </div>
          <iframe id="iframe-${index}-0" src="${cleanUrls[0]}"
                  style="width:100%; height:calc(100% - 40px); border:0;" frameborder="0"
                  scrolling="auto" allow="fullscreen; clipboard-read; clipboard-write"></iframe>
          <div id="searchbox-m${index+1}"></div>
          <div id="results-m${index+1}" class="gcse-results-host"></div>
        `;
      } else {
        const tabs = cleanUrls.map((u, i) =>
          `<button class="tab ${i===0?'active':''}" data-tab="${i}" onclick="activarTab(${index}, ${i})">${new URL(u).hostname}</button>`
        ).join("");
        const iframes = cleanUrls.map((u, i) => `
          <iframe id="iframe-${index}-${i}" src="${u}"
                  style="width:100%; height:calc(100% - 46px); border:0; display:${i===0?'block':'none'};"
                  frameborder="0" scrolling="auto" allow="fullscreen; clipboard-read; clipboard-write"></iframe>
        `).join("");
        container.innerHTML = `
          <div class="panel-header">
            <div class="left"><strong>Monitor ${index+1}</strong></div>
            <div class="right">
              <button onclick="limpiarBusqueda('m${index+1}')">üßπ Limpiar</button>
              <button id="btnFullscreen${index}" onclick="toggleFullscreenGrafico(${index})">üîç Fullscreen</button>
            </div>
          </div>
          <div class="tabs" id="tabs-${index}">${tabs}</div>
          <div style="width:100%; height:calc(100% - 86px);">${iframes}</div>
          <div id="searchbox-m${index+1}"></div>
          <div id="results-m${index+1}" class="gcse-results-host"></div>
        `;
      }
      resetAndRenderCSE('m' + (index+1));
    }

    function activarTab(index, i) {
      const tabsWrap = document.getElementById(`tabs-${index}`); if (!tabsWrap) return;
      tabsWrap.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      const target = tabsWrap.querySelector(`.tab[data-tab='${i}']`);
      if (target) target.classList.add("active");
      const container = document.querySelector(`.player-container[data-index='${index}']`); if (!container) return;
      container.querySelectorAll("iframe[id^='iframe-']").forEach((f, idx) => {
        f.style.display = (idx === i) ? "block" : "none";
      });
    }

    function cargarGraficoTV(index) {
      // Usa seleccionados (en orden visual actual). El filtro no afecta la apertura.
      const urls = getUrlsFromLinkBoxInOrder(index);
      const finalUrls = urls.length ? urls : ["https://cuervo-123.github.io/GLOBALTV4YOUPLUS/"];
      renderIframesInContainer(index, finalUrls);
    }

    function quitarGraficoTV(index) {
      const container = document.querySelector(`.player-container[data-index='${index}']`);
      container.innerHTML = `
        <div class="panel-header">
          <div class="left"><strong>Monitor ${index+1}</strong></div>
          <div class="right">
            <button onclick="limpiarBusqueda('m${index+1}')">üßπ Limpiar</button>
            <button id="btnFullscreen${index}" onclick="toggleFullscreenGrafico(${index})">üîç Fullscreen</button>
          </div>
        </div>
        <video id="player${index + 1}" controls></video>
        <div id="searchbox-m${index+1}"></div>
        <div id="results-m${index+1}" class="gcse-results-host"></div>`;
      resetAndRenderCSE('m' + (index+1));
    }

    function toggleFullscreenGrafico(index) {
      const container = document.querySelector(`.player-container[data-index='${index}']`);
      const iframe = container.querySelector('iframe');
      if (!iframe) { alert("No hay gr√°fico/iframe para esta pantalla."); return; }
      const isFullscreen = iframe.classList.toggle("fullscreen-iframe");
      let botonSalir = document.getElementById(`btnExitFullscreen${index}`);
      if (isFullscreen) {
        if (!botonSalir) {
          botonSalir = document.createElement("button");
          botonSalir.id = `btnExitFullscreen${index}`;
          botonSalir.textContent = "‚ùå Salir de Fullscreen";
          botonSalir.className = "fullscreen-iframe-button";
          botonSalir.onclick = () => toggleFullscreenGrafico(index);
          document.body.appendChild(botonSalir);
        }
      } else {
        if (botonSalir) botonSalir.remove();
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      [0,1,2,3].forEach(initSitePicker);
    });

    /* ========= Favoritos (stubs) ========= */
    function mostrarFavoritos() { document.getElementById("modalFavoritos").style.display = "flex"; }
    function cerrarModal() { document.getElementById("modalFavoritos").style.display = "none"; }
    function exportarFavoritos() { alert("Exportar favoritos (mant√©n tu implementaci√≥n actual aqu√≠)."); }
    function desbloquearAdulto() { alert("Desbloqueo de adultos (mant√©n tu implementaci√≥n actual aqu√≠)."); }
    function cargarCanalesInternos() { alert("Carga de canales internos (mant√©n tu implementaci√≥n actual aqu√≠)."); }
    function agregarAFavoritos() { alert("Agregar a favoritos (usa tu l√≥gica)."); }
    function iniciarAleatorio() { alert("Aleatorio por monitor (usa tu l√≥gica)."); }
    function detenerAleatorio() { alert("Detener aleatorio por monitor (usa tu l√≥gica)."); }
    function reproducirDesdeBusqueda() { alert("Reproducir desde b√∫squeda (si aplica a YouTube)."); }

    /* ========= LIMPIAR B√öSQUEDA ========= */
    function limpiarBusqueda(gname) {
      try {
        if (window.__CSE_READY__ && google?.search?.cse?.element) {
          const el = google.search.cse.element.getElement(gname);
          if (el?.clearAllResults) el.clearAllResults();
          else if (el?.execute) el.execute('');
        }
      } catch(e) {
        console.warn('No se pudo usar API CSE para limpiar', gname, e);
      }
      resetAndRenderCSE(gname);
    }
    function limpiarResultados() {
      ['m1','m2','m3','m4'].forEach(limpiarBusqueda);
    }
  </script>
</body>
</html>
