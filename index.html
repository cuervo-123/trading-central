<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>THE APPTV CENTRAL ‚Äî Multi Monitor</title>

  <!-- Config CSE: render expl√≠cito y callback cuando cargue -->
  <script>
    window.__gcse = {
      parsetags: 'explicit',
      callback: function() {
        try {
          window.__CSE_READY__ = true;
          ['m1','m2','m3','m4'].forEach(renderCSEPair);
          console.log('CSE listo ‚úÖ');
        } catch (e) {
          console.warn('CSE callback error:', e);
        }
      }
    };
  </script>
  <!-- Google Programmable Search (UNA sola vez) -->
  <script async src="https://cse.google.com/cse.js?cx=04f5ff6986fe641ad"></script>

  <!-- HLS -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    :root { --azul:#5892bd; }
    body { background-color: #868980; color: #3a4e6e; font-family: sans-serif; margin: 0; padding: 0; }
    header, main, footer { padding: 1rem; }

    #carrusel-wrapper { position: relative; }
    #canales-inferiores { display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 0.5rem; padding: 1rem; background: #1e1f33; scroll-behavior: smooth; }
    .canal { background: #80f077; border-radius: 10px; padding: 0.5rem 1rem; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
    .canal:hover { background: #d4d4ea; }
    .flecha-carrusel { position: absolute; top: 50%; transform: translateY(-50%); font-size: 2rem; color: white; background: rgba(0, 0, 0, 0.5); border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; z-index: 10; }
    .flecha-izquierda { left: 5px; } .flecha-derecha { right: 5px; }

    .player-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
    .player-container { position: relative; width: 100%; height: 55vh; background: #fff; overflow: hidden; display:flex; flex-direction:column; border-radius: 8px; }
    video, .player-container iframe { width: 100%; height: 100%; object-fit: cover; }

    .panel-header { display:flex; justify-content:space-between; align-items:center; background:var(--azul); color:#fff; padding:6px 10px; }
    .panel-header .left { display:flex; align-items:center; gap:8px; }
    .panel-header .right { display:flex; gap:6px; }
    .panel-header button { background:#fff; color:#000; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; }
    .panel-header button:hover { background:#eee; }

    .gcse-searchresults-only, .gcse-results-host { flex:1; overflow:auto; }

    .botones-panel { margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
    button { padding: 0.4rem 0.7rem; background:var(--azul); border: none; border-radius: 6px; color: white; cursor: pointer; }
    button:hover { filter: brightness(0.95); }
    .site-select { max-width: 420px; width: 100%; min-height: 112px; }
    .site-controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0; }
    .tab { padding:6px 10px; border:1px solid #444; border-radius:6px; cursor:pointer; background:#2b2b2b; color:#fff; }
    .tab.active { background:#333; }
    .grid-split { display:grid; gap:8px; width:100%; height:100%; }

    .fullscreen-iframe { position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 9999 !important; background: black !important; }
    .fullscreen-iframe-button { position: fixed; top: 10px; right: 10px; z-index: 10000; background: #fff; color: #000; border: 2px solid #000; border-radius: 5px; padding: 5px 10px; cursor: pointer; }

    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: #fff; color:#111; padding: 1rem; border-radius: 10px; width: min(800px, 90vw); max-height: 80vh; overflow: auto; }
    #listaFavoritos { list-style: none; padding: 0; margin:0; }
    #listaFavoritos li { padding: 0.5rem; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }

    #buscador { width: 100%; padding: 0.5rem; margin: 0.5rem 0 1rem; border: none; border-radius: 5px; }
  </style>
</head>
<body>
  <header>
    <h1>THE APPTV CENTRAL</h1>

    <div id="carrusel-wrapper">
      <button class="flecha-carrusel flecha-izquierda" onclick="scrollCarrusel(-1)">‚¨ÖÔ∏è</button>
      <div id="canales-inferiores"></div>
      <button class="flecha-carrusel flecha-derecha" onclick="scrollCarrusel(1)">‚û°Ô∏è</button>
    </div>

    <div id="youtube-controls" style="display: flex; gap: 0.5rem; margin-top: 1rem;">
      <input id="youtubeSearch" type="text" placeholder="Buscar en YouTube..." style="flex: 1; padding: 0.5rem;" />
      <button onclick="buscarYT()">üîç Buscar</button>
      <button onclick="toggleRotacion()">‚è∏Ô∏è Pausar</button>
      <button onclick="siguienteVideo()">‚è≠Ô∏è Siguiente</button>
    </div>

    <input type="text" id="buscador" placeholder="Buscar canal de la lista..." />
    <input type="file" id="cargarArchivo" accept=".json,.m3u8,.m3u" />
    <button onclick="cargarCanalesInternos()">üéûÔ∏è Cargar Canales Internos</button>
    <button onclick="mostrarFavoritos()">üìÅ Ver Favoritos</button>
    <button onclick="exportarFavoritos()">üíæ Exportar Favoritos</button>
    <button onclick="desbloquearAdulto()">üîêüîë Desbloquear Adultos</button>

    <div style="margin-top:8px;">
      <button onclick="limpiarResultados()">üßπ Limpiar TODO (m1‚Äìm4)</button>
    </div>
  </header>

  <main>
    <div class="player-grid">
      <!-- MONITOR 1 -->
      <div class="player-container" data-index="0" id="monitor0">
        <div class="panel-header">
          <div class="left"><strong>Monitor 1</strong></div>
          <div class="right">
            <button onclick="limpiarBusqueda('m1')">üßπ Limpiar</button>
            <button id="btnFullscreen0" onclick="toggleFullscreenGrafico(0)">üîç Fullscreen</button>
          </div>
        </div>
        <div id="searchbox-m1"></div>
        <div id="results-m1" class="gcse-results-host"></div>

        <div class="botones-panel">
          <select id="siteSelect0" multiple size="5" class="site-select"></select>
          <div class="site-controls">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="splitMode0" checked> Vista dividida
            </label>
            <button onclick="cargarGraficoTV(0)">üåê Abrir sitios</button>
            <button onclick="guardarSeleccionSitios(0)">üíæ Guardar</button>
            <button onclick="limpiarSeleccionSitios(0)">üßπ Limpiar</button>
          </div>
        </div>
        <div class="botones-panel">
          <input type="text" id="symbolInput0" placeholder="S√≠mbolo (ej: EURUSD)" style="flex:1; padding:0.5rem;" />
          <button onclick="cargarGraficoTV(0)">üìà Gr√°fico</button>
          <button onclick="quitarGraficoTV(0)">üóëÔ∏è Quitar</button>
        </div>
      </div>

      <!-- MONITOR 2 -->
      <div class="player-container" data-index="1" id="monitor1">
        <div class="panel-header">
          <div class="left"><strong>Monitor 2</strong></div>
          <div class="right">
            <button onclick="limpiarBusqueda('m2')">üßπ Limpiar</button>
            <button id="btnFullscreen1" onclick="toggleFullscreenGrafico(1)">üîç Fullscreen</button>
          </div>
        </div>
        <div id="searchbox-m2"></div>
        <div id="results-m2" class="gcse-results-host"></div>

        <div class="botones-panel">
          <select id="siteSelect1" multiple size="5" class="site-select"></select>
          <div class="site-controls">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="splitMode1" checked> Vista dividida
            </label>
            <button onclick="cargarGraficoTV(1)">üåê Abrir sitios</button>
            <button onclick="guardarSeleccionSitios(1)">üíæ Guardar</button>
            <button onclick="limpiarSeleccionSitios(1)">üßπ Limpiar</button>
          </div>
        </div>
        <div class="botones-panel">
          <input type="text" id="symbolInput1" placeholder="S√≠mbolo (ej: EURUSD)" style="flex:1; padding:0.5rem;" />
          <button onclick="cargarGraficoTV(1)">üìà Gr√°fico</button>
          <button onclick="quitarGraficoTV(1)">üóëÔ∏è Quitar</button>
        </div>
      </div>

      <!-- MONITOR 3 -->
      <div class="player-container" data-index="2" id="monitor2">
        <div class="panel-header">
          <div class="left"><strong>Monitor 3</strong></div>
          <div class="right">
            <button onclick="limpiarBusqueda('m3')">üßπ Limpiar</button>
            <button id="btnFullscreen2" onclick="toggleFullscreenGrafico(2)">üîç Fullscreen</button>
          </div>
        </div>
        <div id="searchbox-m3"></div>
        <div id="results-m3" class="gcse-results-host"></div>

        <div class="botones-panel">
          <select id="siteSelect2" multiple size="5" class="site-select"></select>
          <div class="site-controls">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="splitMode2" checked> Vista dividida
            </label>
            <button onclick="cargarGraficoTV(2)">üåê Abrir sitios</button>
            <button onclick="guardarSeleccionSitios(2)">üíæ Guardar</button>
            <button onclick="limpiarSeleccionSitios(2)">üßπ Limpiar</button>
          </div>
        </div>
        <div class="botones-panel">
          <input type="text" id="symbolInput2" placeholder="S√≠mbolo (ej: EURUSD)" style="flex:1; padding:0.5rem;" />
          <button onclick="cargarGraficoTV(2)">üìà Gr√°fico</button>
          <button onclick="quitarGraficoTV(2)">üóëÔ∏è Quitar</button>
        </div>
      </div>

      <!-- MONITOR 4 -->
      <div class="player-container" data-index="3" id="monitor3">
        <div class="panel-header">
          <div class="left"><strong>Monitor 4</strong></div>
          <div class="right">
            <button onclick="limpiarBusqueda('m4')">üßπ Limpiar</button>
            <button id="btnFullscreen3" onclick="toggleFullscreenGrafico(3)">üîç Fullscreen</button>
          </div>
        </div>
        <div id="searchbox-m4"></div>
        <div id="results-m4" class="gcse-results-host"></div>

        <div class="botones-panel">
          <select id="siteSelect3" multiple size="5" class="site-select"></select>
          <div class="site-controls">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="splitMode3" checked> Vista dividida
            </label>
            <button onclick="cargarGraficoTV(3)">üåê Abrir sitios</button>
            <button onclick="guardarSeleccionSitios(3)">üíæ Guardar</button>
            <button onclick="limpiarSeleccionSitios(3)">üßπ Limpiar</button>
          </div>
        </div>
        <div class="botones-panel">
          <input type="text" id="symbolInput3" placeholder="S√≠mbolo (ej: EURUSD)" style="flex:1; padding:0.5rem;" />
          <button onclick="cargarGraficoTV(3)">üìà Gr√°fico</button>
          <button onclick="quitarGraficoTV(3)">üóëÔ∏è Quitar</button>
        </div>
      </div>

    </div>
  </main>

  <!-- MODALES -->
  <div class="modal" id="modalFavoritos">
    <div class="modal-content">
      <h3>üéØ Favoritos</h3>
      <ul id="listaFavoritos"></ul>
      <div style="text-align:right;margin-top:10px;">
        <button onclick="cerrarModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalPantalla">
    <div class="modal-content">
      <h3>üñ•Ô∏è ¬øEn qu√© pantalla quieres ver este canal?</h3>
      <div style="display:flex; gap: 1rem; justify-content:center; margin: 1rem 0;">
        <button onclick="reproducirEnPantallaSeleccionada(0)">Pantalla 1</button>
        <button onclick="reproducirEnPantallaSeleccionada(1)">Pantalla 2</button>
        <button onclick="reproducirEnPantallaSeleccionada(2)">Pantalla 3</button>
        <button onclick="reproducirEnPantallaSeleccionada(3)">Pantalla 4</button>
      </div>
      <div style="text-align:right;">
        <button onclick="cerrarModalPantalla()">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    /* ====== CSE program√°tico ====== */
    function renderCSEPair(gname) {
      // Renderiza el searchbox
      google.search.cse.element.render({
        div: 'searchbox-' + gname,
        tag: 'searchbox-only',
        gname: gname,
        attributes: { enableAutoComplete: true, autoCompleteMaxCompletions: 8 }
      });
      // Renderiza los resultados
      google.search.cse.element.render({
        div: 'results-' + gname,
        tag: 'searchresults-only',
        gname: gname
      });
    }

    function resetAndRenderCSE(gname) {
      // Vac√≠a contenedores y renderiza de nuevo (esto limpia input + resultados)
      const sb = document.getElementById('searchbox-' + gname);
      const rs = document.getElementById('results-' + gname);
      if (sb) sb.innerHTML = '';
      if (rs) rs.innerHTML = '';
      if (window.__CSE_READY__) {
        renderCSEPair(gname);
      }
    }

    /* ========= CARRUSEL ========= */
    function scrollCarrusel(direccion) {
      const carrusel = document.getElementById("canales-inferiores");
      carrusel.scrollBy({ left: 300 * direccion, behavior: "smooth" });
    }

    /* ========= UTIL: parse M3U ========= */
    function parseM3U(texto) {
      const lineas = texto.split('\n');
      const canales = [];
      for (let i = 0; i < lineas.length; i++) {
        const linea = lineas[i].trim();
        if (linea.startsWith('#EXTINF')) {
          const titulo = linea.split(',')[1]?.trim() || 'Canal sin nombre';
          const url = lineas[i + 1]?.trim();
          if (url && url.startsWith('http')) canales.push({ nombre: titulo, url });
        }
      }
      return canales;
    }

    let canalSeleccionado = null;
    let listaOriginalCanales = [];

    function mostrarCanales(canales, guardarOriginal = false) {
      if (guardarOriginal) listaOriginalCanales = canales;
      const contenedor = document.getElementById("canales-inferiores");
      contenedor.innerHTML = "";
      canales.forEach((canal) => {
        const div = document.createElement("div");
        div.className = "canal";
        div.textContent = canal.nombre;
        div.onclick = () => mostrarModalPantalla(canal.url);
        contenedor.appendChild(div);
      });
    }

    function filtrarCanales() {
      const texto = (document.getElementById("buscador").value || "").toLowerCase();
      const filtrados = listaOriginalCanales.filter(canal =>
        (canal.nombre || "").toLowerCase().includes(texto)
      );
      mostrarCanales(filtrados);
    }
    document.addEventListener('DOMContentLoaded', () => {
      const buscador = document.getElementById("buscador");
      if (buscador) buscador.addEventListener("input", filtrarCanales);
    });

    /* ========= Modal elegir pantalla ========= */
    function mostrarModalPantalla(url) {
      canalSeleccionado = url;
      document.getElementById("modalPantalla").style.display = "flex";
    }
    function cerrarModalPantalla() {
      document.getElementById("modalPantalla").style.display = "none";
      canalSeleccionado = null;
    }
    function reproducirEnPantallaSeleccionada(pantallaIndex) {
      if (canalSeleccionado) {
        const container = document.querySelector(`.player-container[data-index='${pantallaIndex}']`);
        container.innerHTML = `<div class="panel-header">
            <div class="left"><strong>Monitor ${pantallaIndex+1}</strong></div>
            <div class="right">
              <button onclick="limpiarBusqueda('m${pantallaIndex+1}')">üßπ Limpiar</button>
              <button id="btnFullscreen${pantallaIndex}" onclick="toggleFullscreenGrafico(${pantallaIndex})">üîç Fullscreen</button>
            </div>
          </div>
          <video id="player${pantallaIndex + 1}" controls></video>
          <div id="searchbox-m${pantallaIndex+1}"></div>
          <div id="results-m${pantallaIndex+1}" class="gcse-results-host"></div>`;
        reproducirCanal(canalSeleccionado, pantallaIndex);

        // Re-render CSE para ese monitor (por si lo reemplazamos con video)
        resetAndRenderCSE('m' + (pantallaIndex+1));
      }
      cerrarModalPantalla();
    }

    /* ========= Reproducir HLS ========= */
    function reproducirCanal(url, playerIndex) {
      const player = document.getElementById(`player${playerIndex + 1}`);
      if (player && player.hlsInstance) player.hlsInstance.destroy();

      if (player && Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(player);
        player.hlsInstance = hls;
        hls.on(Hls.Events.MANIFEST_PARSED, () => player.play());
      } else if (player && player.canPlayType && player.canPlayType('application/vnd.apple.mpegurl')) {
        player.src = url;
        player.addEventListener('loadedmetadata', () => player.play());
      } else {
        alert("Tu navegador no soporta la reproducci√≥n de este canal.");
      }
    }

    /* ========= Carga autom√°tica de listas ========= */
    Promise.all([
      fetch("update2.m3u").then(res => res.text()),
      fetch("colombia.m3u").then(res => res.text()),
      fetch("brazil.m3u").then(res => res.text())
    ])
    .then(([data1, data2, data3]) => {
      const canales = [...parseM3U(data1), ...parseM3U(data2), ...parseM3U(data3)];
      mostrarCanales(canales, true);
      console.log("‚úÖ Todas las listas M3U fueron cargadas autom√°ticamente");
    })
    .catch(err => console.error("‚ùå Error al cargar alguna lista M3U:", err));

    /* ========= YouTube con rotaci√≥n ========= */
    let apiKey = "AIzaSyA4NpwgJmEzBGGTzFFjShyrtWICgSSml-I";
    let rotationInterval = null, currentVideoIndex = 0, youtubeResults = [], isPaused = false;

    function targetIndexForYouTube() {
      const hasCSE = !!document.querySelector(".player-container[data-index='0'] #results-m1");
      return hasCSE ? 1 : 0;
    }

    function buscarYT() {
      const query = document.getElementById("youtubeSearch").value.trim();
      if (!query) return alert("Escribe una b√∫squeda.");
      fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=40&q=${encodeURIComponent(query)}&key=${apiKey}`)
        .then(res => res.json())
        .then(data => {
          if (!data.items || !data.items.length) return alert("No se encontraron resultados.");
          youtubeResults = data.items;
          currentVideoIndex = 0;
          reproducirVideoActual();
          iniciarRotacion();
        })
        .catch(err => { console.error("Error al buscar en YouTube:", err); alert("Error al buscar videos."); });
    }

    function reproducirVideoActual() {
      const video = youtubeResults[currentVideoIndex]; if (!video) return;
      const videoId = video.id.videoId;
      const iframe = document.createElement("iframe");
      iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0`;
      iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
      iframe.allowFullscreen = true;
      const idx = targetIndexForYouTube();
      const container = document.querySelector(`.player-container[data-index='${idx}']`);
      const header = container.querySelector(".panel-header")?.outerHTML || "";
      container.innerHTML = `${header}
        <div id="searchbox-m${idx+1}"></div>
        <div id="results-m${idx+1}" class="gcse-results-host"></div>`;
      container.appendChild(iframe);

      // Re-render CSE en ese monitor para no perder su buscador
      resetAndRenderCSE('m' + (idx+1));
    }

    function iniciarRotacion() {
      detenerRotacion();
      rotationInterval = setInterval(() => { if (!isPaused) siguienteVideo(); }, 3 * 60 * 1000);
    }
    function detenerRotacion() { if (rotationInterval) clearInterval(rotationInterval); }
    function toggleRotacion() { isPaused = !isPaused; alert(isPaused ? "‚è∏Ô∏è Rotaci√≥n pausada." : "‚ñ∂Ô∏è Rotaci√≥n reanudada."); }
    function siguienteVideo() { currentVideoIndex = (currentVideoIndex + 1) % youtubeResults.length; reproducirVideoActual(); }

    /* ========= Sitios favoritos / gr√°ficos por monitor ========= */
    const FAVORITE_SITES = [
      { label: "Central App's", url: "https://cuervo-123.github.io/GLOBALTV4YOUPLUS/" },
      { label: "Global country Tv App", url: "https://cuervo-123.github.io/tv4you/" },
      { label: "Logo full acces app", url: "https://cuervo-123.github.io/mi-tv-station/" },
      { label: "4 monitors pro app", url: "https://cuervo-123.github.io/GLOBALTV4YOU/" },
      { label: "Karaoke app pro", url: "https://cuervo-123.github.io/Editor-iptv-Plus/" },
      { label: "x app", url: "https://wap.tizam.club/fil_my_dlya_vzroslyh/podrostki_18/ryzhen_kie_ochen_seksual_ny_5/" },
      { label: "App database", url: "https://cuervo-123.github.io/GLOBALTV4YOUPLUS/" },
      { label: "Multi Functions pro", url: "https://cuervo-123.github.io/mi-tv-station-v-10.1/" },
      { label: "weltrade", url: "https://www.weltrade.com/tools/charts/" },
      
    ];
    const LS_KEY = (idx) => `siteSelection:${idx}`;
    const normalizeUrl = (u) => {
      if (!u) return "";
      let url = u.trim();
      if (!/^https?:\/\//i.test(url)) url = "https://" + url.replace(/^\/+/, "");
      return url;
    };

    function initSitePicker(index) {
      const select = document.getElementById(`siteSelect${index}`);
      if (!select) return;
      select.innerHTML = FAVORITE_SITES.map(s =>
        `<option value="${s.url}">${s.label} ‚Äî ${s.url}</option>`
      ).join("");
      const saved = JSON.parse(localStorage.getItem(LS_KEY(index)) || "[]");
      Array.from(select.options).forEach(opt => {
        if (saved.includes(opt.value)) opt.selected = true;
      });
    }

    function guardarSeleccionSitios(index) {
      const select = document.getElementById(`siteSelect${index}`);
      const seleccion = Array.from(select.selectedOptions).map(o => o.value);
      localStorage.setItem(LS_KEY(index), JSON.stringify(seleccion));
      alert("Selecci√≥n guardada ‚úÖ");
    }

    function limpiarSeleccionSitios(index) {
      const select = document.getElementById(`siteSelect${index}`);
      Array.from(select.options).forEach(o => (o.selected = false));
      localStorage.removeItem(LS_KEY(index));
    }

    function renderIframesInContainer(index, urls) {
      const container = document.querySelector(`.player-container[data-index='${index}']`);
      if (!container) return;
      const cleanUrls = urls.map(normalizeUrl).filter(Boolean);
      if (cleanUrls.length === 0) return alert("Selecciona al menos 1 sitio.");
      const split = document.getElementById(`splitMode${index}`)?.checked && cleanUrls.length > 1;

      if (split) {
        const n = cleanUrls.length;
        let cols = 2;
        if (n === 3) cols = 3;
        if (n >= 4) cols = 3;
        const gridStyle = `grid-template-columns: repeat(${cols}, 1fr); grid-auto-rows: minmax(200px, 1fr);`;
        container.innerHTML = `
          <div class="panel-header">
            <div class="left"><strong>Monitor ${index+1}</strong></div>
            <div class="right">
              <button onclick="limpiarBusqueda('m${index+1}')">üßπ Limpiar</button>
              <button id="btnFullscreen${index}" onclick="toggleFullscreenGrafico(${index})">üîç Fullscreen</button>
            </div>
          </div>
          <div class="grid-split" style="${gridStyle}; width:100%; height:calc(100% - 40px);">
            ${cleanUrls.map(u => `
              <iframe src="${u}" style="width:100%; height:100%; border:0;"
                      frameborder="0" scrolling="auto"
                      allow="fullscreen; clipboard-read; clipboard-write"></iframe>
            `).join("")}
          </div>
          <div id="searchbox-m${index+1}"></div>
          <div id="results-m${index+1}" class="gcse-results-host"></div>
        `;
      } else if (cleanUrls.length === 1) {
        container.innerHTML = `
          <div class="panel-header">
            <div class="left"><strong>Monitor ${index+1}</strong></div>
            <div class="right">
              <button onclick="limpiarBusqueda('m${index+1}')">üßπ Limpiar</button>
              <button id="btnFullscreen${index}" onclick="toggleFullscreenGrafico(${index})">üîç Fullscreen</button>
            </div>
          </div>
          <iframe id="iframe-${index}-0" src="${cleanUrls[0]}"
                  style="width:100%; height:calc(100% - 40px); border:0;" frameborder="0"
                  scrolling="auto" allow="fullscreen; clipboard-read; clipboard-write"></iframe>
          <div id="searchbox-m${index+1}"></div>
          <div id="results-m${index+1}" class="gcse-results-host"></div>
        `;
      } else {
        const tabs = cleanUrls.map((u, i) =>
          `<button class="tab ${i===0?'active':''}" data-tab="${i}" onclick="activarTab(${index}, ${i})">${new URL(u).hostname}</button>`
        ).join("");
        const iframes = cleanUrls.map((u, i) => `
          <iframe id="iframe-${index}-${i}" src="${u}"
                  style="width:100%; height:calc(100% - 46px); border:0; display:${i===0?'block':'none'};"
                  frameborder="0" scrolling="auto" allow="fullscreen; clipboard-read; clipboard-write"></iframe>
        `).join("");
        container.innerHTML = `
          <div class="panel-header">
            <div class="left"><strong>Monitor ${index+1}</strong></div>
            <div class="right">
              <button onclick="limpiarBusqueda('m${index+1}')">üßπ Limpiar</button>
              <button id="btnFullscreen${index}" onclick="toggleFullscreenGrafico(${index})">üîç Fullscreen</button>
            </div>
          </div>
          <div class="tabs" id="tabs-${index}">${tabs}</div>
          <div style="width:100%; height:calc(100% - 86px);">${iframes}</div>
          <div id="searchbox-m${index+1}"></div>
          <div id="results-m${index+1}" class="gcse-results-host"></div>
        `;
      }

      // Re-render CSE en ese monitor para que siga estando disponible
      resetAndRenderCSE('m' + (index+1));
    }

    function activarTab(index, i) {
      const tabsWrap = document.getElementById(`tabs-${index}`);
      if (!tabsWrap) return;
      tabsWrap.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      const target = tabsWrap.querySelector(`.tab[data-tab='${i}']`);
      if (target) target.classList.add("active");
      const container = document.querySelector(`.player-container[data-index='${index}']`);
      if (!container) return;
      container.querySelectorAll("iframe[id^='iframe-']").forEach((f, idx) => {
        f.style.display = (idx === i) ? "block" : "none";
      });
    }

    function cargarGraficoTV(index) {
      const select = document.getElementById(`siteSelect${index}`);
      const seleccion = select ? Array.from(select.selectedOptions).map(o => o.value) : [];
      const urls = (seleccion.length > 0) ? seleccion : ["https://cuervo-123.github.io/GLOBALTV4YOUPLUS/"];
      renderIframesInContainer(index, urls);
    }

    function quitarGraficoTV(index) {
      const container = document.querySelector(`.player-container[data-index='${index}']`);
      container.innerHTML = `
        <div class="panel-header">
          <div class="left"><strong>Monitor ${index+1}</strong></div>
          <div class="right">
            <button onclick="limpiarBusqueda('m${index+1}')">üßπ Limpiar</button>
            <button id="btnFullscreen${index}" onclick="toggleFullscreenGrafico(${index})">üîç Fullscreen</button>
          </div>
        </div>
        <video id="player${index + 1}" controls></video>
        <div id="searchbox-m${index+1}"></div>
        <div id="results-m${index+1}" class="gcse-results-host"></div>`;
      resetAndRenderCSE('m' + (index+1));
    }

    function toggleFullscreenGrafico(index) {
      const container = document.querySelector(`.player-container[data-index='${index}']`);
      const iframe = container.querySelector('iframe');
      if (!iframe) { alert("No hay gr√°fico/iframe para esta pantalla."); return; }
      const isFullscreen = iframe.classList.toggle("fullscreen-iframe");
      let botonSalir = document.getElementById(`btnExitFullscreen${index}`);
      if (isFullscreen) {
        if (!botonSalir) {
          botonSalir = document.createElement("button");
          botonSalir.id = `btnExitFullscreen${index}`;
          botonSalir.textContent = "‚ùå Salir de Fullscreen";
          botonSalir.className = "fullscreen-iframe-button";
          botonSalir.onclick = () => toggleFullscreenGrafico(index);
          document.body.appendChild(botonSalir);
        }
      } else {
        if (botonSalir) botonSalir.remove();
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      [0,1,2,3].forEach(initSitePicker);
    });

    /* ========= Favoritos (stubs m√≠nimos) ========= */
    function mostrarFavoritos() { document.getElementById("modalFavoritos").style.display = "flex"; }
    function cerrarModal() { document.getElementById("modalFavoritos").style.display = "none"; }
    function exportarFavoritos() { alert("Exportar favoritos (mant√©n tu implementaci√≥n actual aqu√≠)."); }
    function desbloquearAdulto() { alert("Desbloqueo de adultos (mant√©n tu implementaci√≥n actual aqu√≠)."); }
    function cargarCanalesInternos() { alert("Carga de canales internos (mant√©n tu implementaci√≥n actual aqu√≠)."); }
    function agregarAFavoritos() { alert("Agregar a favoritos (usa tu l√≥gica)."); }
    function iniciarAleatorio() { alert("Aleatorio por monitor (usa tu l√≥gica)."); }
    function detenerAleatorio() { alert("Detener aleatorio por monitor (usa tu l√≥gica)."); }
    function reproducirDesdeBusqueda() { alert("Reproducir desde b√∫squeda (si aplica a YouTube)."); }

    /* ========= LIMPIAR B√öSQUEDA ========= */
    function limpiarBusqueda(gname) {
      // 1) API oficial (si existe)
      try {
        if (window.__CSE_READY__ && google?.search?.cse?.element) {
          const el = google.search.cse.element.getElement(gname);
          if (el?.clearAllResults) el.clearAllResults();
          else if (el?.execute) el.execute('');
        }
      } catch(e) {
        console.warn('No se pudo usar API CSE para limpiar', gname, e);
      }
      // 2) Re-render obligatorio: limpia input + resultados
      resetAndRenderCSE(gname);
    }
    function limpiarResultados() {
      ['m1','m2','m3','m4'].forEach(limpiarBusqueda);
    }
  </script>
</body>
</html>
